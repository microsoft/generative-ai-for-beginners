# プロンプトエンジニアリングの基礎

[![プロンプトエンジニアリングの基礎](../../../translated_images/04-lesson-banner.png?WT.d904d510033d5f0283f2caff5f735050f929dd196a1fc25fefa18433347fe463.ja.mc_id=academic-105485-koreyst)](https://aka.ms/gen-ai-lesson4-gh?WT.mc_id=academic-105485-koreyst)

## はじめに
このモジュールでは、生成AIモデルで効果的なプロンプトを作成するための基本的な概念と技術について学びます。LLMにプロンプトを書く方法も重要です。慎重に作成されたプロンプトは、より良い品質の応答を得ることができます。しかし、_プロンプト_ や _プロンプトエンジニアリング_ という用語は具体的に何を意味するのでしょうか？また、LLMに送るプロンプトの _入力_ をどのように改善すれば良いのでしょうか？これらの質問に、この章と次の章で答えていきます。

_生成AI_ は、ユーザーのリクエストに応じて新しいコンテンツ（例：テキスト、画像、音声、コードなど）を作成することができます。これは、自然言語やコードを使用するために訓練されたOpenAIのGPT（"Generative Pre-trained Transformer"）シリーズのような _大規模言語モデル_ を使用して実現されています。

ユーザーは、技術的な専門知識や訓練を必要とせずに、チャットのような馴染みのあるパラダイムを使ってこれらのモデルと対話できるようになりました。モデルは _プロンプトベース_ です - ユーザーがテキスト入力（プロンプト）を送信し、AI応答（コンプリート）を受け取ります。ユーザーはその後、AIと「チャット」しながら、応答が期待に合うまでプロンプトを洗練させることができます。

「プロンプト」は、生成AIアプリの主要な _プログラミングインターフェース_ となり、モデルに何をするかを伝え、返される応答の質に影響を与えます。「プロンプトエンジニアリング」は、プロンプトの _設計と最適化_ に焦点を当て、一貫した高品質の応答を大規模に提供するための急成長中の研究分野です。

## 学習目標

このレッスンでは、プロンプトエンジニアリングとは何か、なぜ重要なのか、そして特定のモデルとアプリケーションの目的に対してどのように効果的なプロンプトを作成できるかを学びます。プロンプトエンジニアリングの基本的な概念とベストプラクティスを理解し、これらの概念が実際の例に適用されるインタラクティブなJupyter Notebooksの「サンドボックス」環境について学びます。

このレッスンの終わりまでに、次のことができるようになります：

1. プロンプトエンジニアリングとは何か、そしてなぜ重要なのかを説明する。
2. プロンプトの構成要素とそれらの使用方法を説明する。
3. プロンプトエンジニアリングのベストプラクティスと技術を学ぶ。
4. 学んだ技術を実際の例に適用し、OpenAIエンドポイントを使用する。

## キー用語

プロンプトエンジニアリング：AIモデルを望ましい出力に導くための入力を設計し、洗練する実践。
トークン化：モデルが理解し処理できる小さな単位、トークンにテキストを変換するプロセス。
指示調整済みLLM：特定の指示で精緻化され、応答の正確性と関連性を向上させた大規模言語モデル（LLM）。

## 学習サンドボックス

プロンプトエンジニアリングは現在、科学というよりは芸術です。それに対する直感を改善する最善の方法は、_より多く練習し_、推奨される技術とモデル固有の最適化を組み合わせた試行錯誤アプローチを採用することです。

このレッスンに付随するJupyter Notebookは、学んだことを試すことができる _サンドボックス_ 環境を提供します - 学習中や、最後のコードチャレンジの一部として。演習を実行するには、次のものが必要です：

1. **Azure OpenAI APIキー** - デプロイされたLLMのサービスエンドポイント。
2. **Pythonランタイム** - Notebookを実行できる環境。
3. **ローカル環境変数** - _準備のために今[SETUP](./../00-course-setup/SETUP.md?WT.mc_id=academic-105485-koreyst)ステップを完了してください_。

Notebookには_スターター_演習が付属していますが、さらに多くの例やアイデアを試すために、自分自身で_マークダウン_（説明）や_コード_（プロンプトリクエスト）セクションを追加することをお勧めします - プロンプト設計の直感を養うために。

## イラストガイド

このレッスンがカバーする内容の全体像を理解したいですか？このイラストガイドをチェックして、カバーされる主要なトピックとそれぞれで考慮すべき重要なポイントを理解してください。レッスンのロードマップは、基本的な概念と課題の理解から、それらを関連するプロンプトエンジニアリング技術とベストプラクティスで解決する方法に至るまでの流れを示しています。このガイドの「高度な技術」セクションは、このカリキュラムの_次の_章でカバーされる内容に関連しています。

![プロンプトエンジニアリングのイラストガイド](../../../translated_images/04-prompt-engineering-sketchnote.png?WT.a936f69bc33c7a783015f6747ea56d0f0071349644cd9031f9b8d20a3eec8696.ja.mc_id=academic-105485-koreyst)

## 私たちのスタートアップ

では、_このトピック_ が、[AIの革新を教育に](https://educationblog.microsoft.com/2023/06/collaborating-to-bring-ai-innovation-to-education?WT.mc_id=academic-105485-koreyst)もたらすという私たちのスタートアップの使命とどのように関連しているかを考えてみましょう。私たちは_パーソナライズされた学習_のAI搭載アプリケーションを構築したいと考えています - では、私たちのアプリケーションの異なるユーザーがどのようにプロンプトを「設計」するかを考えてみましょう：

- **管理者**は、AIに_カリキュラムデータを分析してカバレッジのギャップを特定するように頼む_かもしれません。AIは結果を要約したり、コードで視覚化したりすることができます。
- **教育者**は、AIに_ターゲットオーディエンスとトピックのためのレッスンプランを生成するように頼む_かもしれません。AIは指定されたフォーマットでパーソナライズされたプランを構築できます。
- **学生**は、AIに_難しい科目を教えてもらうように頼む_かもしれません。AIは、学生のレベルに合わせたレッスン、ヒント、例でガイドできます。

これはほんの始まりに過ぎません。[教育のためのプロンプト](https://github.com/microsoft/prompts-for-edu/tree/main?WT.mc_id=academic-105485-koreyst) - 教育専門家によってキュレーションされたオープンソースのプロンプトライブラリをチェックして、可能性の広がりを感じてください！_サンドボックスでこれらのプロンプトのいくつかを実行してみたり、OpenAI Playgroundを使用して何が起こるかを見てみましょう！_

<!--
LESSON TEMPLATE:
このユニットでは、コアコンセプト#1をカバーする必要があります。
概念を例や参考文献で強化します。

CONCEPT #1:
プロンプトエンジニアリング。
定義し、なぜそれが必要なのかを説明します。
-->

## プロンプトエンジニアリングとは？

このレッスンは、特定のアプリケーションの目的とモデルに対して一貫した高品質の応答（コンプリート）を提供するために、テキスト入力（プロンプト）を _設計し最適化する_ プロセスとして**プロンプトエンジニアリング**を定義することから始めました。これは、2ステップのプロセスと考えることができます：

- 指定されたモデルと目的に対して初期プロンプトを _設計する_
- 応答の質を向上させるためにプロンプトを反復的に _洗練する_

これは必然的に試行錯誤のプロセスであり、最適な結果を得るためにはユーザーの直感と努力が必要です。では、なぜそれが重要なのでしょうか？その質問に答えるために、まず次の3つの概念を理解する必要があります：

- _トークン化_ = モデルがプロンプトを「見る」方法
- _ベースLLM_ = 基礎モデルがプロンプトを「処理」する方法
- _指示調整済みLLM_ = モデルが「タスク」を見ることができる方法

### トークン化

LLMはプロンプトを _トークンのシーケンス_ として見ますが、異なるモデル（またはモデルのバージョン）は同じプロンプトを異なる方法でトークン化することがあります。LLMはトークンで訓練されているため（生のテキストではない）、プロンプトがトークン化される方法は生成される応答の質に直接影響を与えます。

トークン化がどのように機能するかの直感を得るために、以下に示す[OpenAIトークナイザー](https://platform.openai.com/tokenizer?WT.mc_id=academic-105485-koreyst)のようなツールを試してみてください。プロンプトをコピーして貼り付け、トークンに変換される様子を確認し、空白文字や句読点の処理方法に注意を払ってください。この例は古いLLM（GPT-3）を示していますので、新しいモデルで試すと異なる結果が得られるかもしれません。

![トークン化](../../../translated_images/04-tokenizer-example.png?WT.f5399316da400747ffe3af9c95e61dc1a85508d57378da23a77538270c4cabf1.ja.mc_id=academic-105485-koreyst)

### コンセプト: 基礎モデル

プロンプトがトークン化された後、「ベースLLM」([Base LLM](https://blog.gopenai.com/an-introduction-to-base-and-instruction-tuned-large-language-models-8de102c785a6?WT.mc_id=academic-105485-koreyst))（または基礎モデル）の主な機能は、そのシーケンス内のトークンを予測することです。LLMは大量のテキストデータセットで訓練されているため、トークン間の統計的関係をよく理解しており、ある程度の自信を持ってその予測を行うことができます。ただし、プロンプトやトークン内の単語の _意味_ を理解しているわけではなく、次の予測で「完了」できるパターンを見ているだけです。ユーザーの介入や事前に設定された条件によって終了されるまで、シーケンスを予測し続けることができます。

プロンプトベースのコンプリートがどのように機能するかを見てみたいですか？上記のプロンプトをAzure OpenAI Studioの[_Chat Playground_](https://oai.azure.com/playground?WT.mc_id=academic-105485-koreyst)にデフォルト設定で入力してみてください。システムはプロンプトを情報のリクエストとして扱うように設定されているため、このコンテキストを満たすコンプリートが表示されるはずです。

しかし、ユーザーが特定の基準やタスクの目的に合った何かを見たい場合はどうでしょうか？ここで_指示調整済み_ LLMが登場します。

![ベースLLMチャットコンプリート](../../../translated_images/04-playground-chat-base.png?WT.7645a03d7989b1c410f2e9e6b503d18e4624f82d9cbf108dac999b8c8988f0ad.ja.mc_id=academic-105485-koreyst)

### コンセプト: 指示調整済みLLM

[指示調整済みLLM](https://blog.gopenai.com/an-introduction-to-base-and-instruction-tuned-large-language-models-8de102c785a6?WT.mc_id=academic-105485-koreyst)は、基礎モデルから始まり、明確な指示を含む例や入力/出力ペア（例：マルチターンの「メッセージ」）で微調整されます - そしてAIの応答はその指示に従うように試みます。

これは、人間のフィードバックを伴う強化学習（RLHF）などの技術を使用して、モデルが_指示に従い_、_フィードバックから学習_ できるように訓練し、実際のアプリケーションに適した応答を生成し、ユーザーの目的により関連するものにします。

試してみましょう - 上記のプロンプトを再訪し、今度は_システムメッセージ_を次の指示をコンテキストとして提供するように変更してください：

> _提供された内容を2年生の生徒向けに要約してください。結果を1段落で3〜5の箇条書きにしてください。_

結果がどのように望ましい目標とフォーマットに調整されているかを見てください？教育者は今、この応答をそのクラスのスライドに直接使用できます。

![指示調整済みLLMチャットコンプリート](../../../translated_images/04-playground-chat-instructions.png?WT.d9c80b15e90815a83ce665bf4418e70205d30318a5a5bcf407b2c92769743593.ja.mc_id=academic-105485-koreyst)

## なぜプロンプトエンジニアリングが必要なのか？

LLMがプロンプトをどのように処理するかを知った今、なぜプロンプトエンジニアリングが必要なのかを考えてみましょう。その答えは、現在のLLMが、プロンプトの構築と最適化に努力を払わずに_信頼性と一貫性のあるコンプリート_を達成することをより困難にする多くの課題を抱えているという事実にあります。例えば：

1. **モデルの応答は確率的です。** _同じプロンプト_は、異なるモデルやモデルバージョンで異なる応答を生成する可能性があります。そして、_同じモデル_であっても異なる時に異なる結果を生成するかもしれません。_プロンプトエンジニアリング技術は、より良いガードレールを提供することでこれらの変動を最小限に抑えるのに役立ちます_。

2. **モデルは応答を作り出すことがあります。** モデルは_大規模だが有限の_データセットで事前に訓練されているため、その訓練範囲外の概念についての知識を欠いています。その結果、事実と矛盾する、不正確または架空のコンプリートを生成することがあります。_プロンプトエンジニアリング技術は、AIに引用や理由を尋ねることで、ユーザーがそのような作り話を特定し、軽減するのを助けます_。

3. **モデルの能力は異なります。** 新しいモデルやモデル世代は、より豊かな能力を持ちますが、コストと複雑さにおいてユニークな特性とトレードオフももたらします。_プロンプトエンジニアリングは、違いを抽象化し、モデル固有の要件にスケーラブルでシームレスな方法で適応するベストプラクティスとワークフローを開発するのに役立ちます_。

OpenAIまたはAzure OpenAI Playgroundでこれを実際に見てみましょう：

- 同じプロンプトを異なるLLMデプロイメント（例：OpenAI、Azure OpenAI、Hugging Face）で使用してください - 変動が見られましたか？
- _同じ_ LLMデプロイメント（例：Azure OpenAI Playground）で同じプロンプトを繰り返し使用してください - これらの変動はどのように異なりましたか？

### 作り話の例

このコースでは、LLMが訓練
テンプレートの本当の価値は、特定のアプリケーションドメインに対して_プロンプトライブラリ_を作成し公開する能力にあります。ここでプロンプトテンプレートは、ターゲットユーザーにとってより関連性が高く正確な応答を得るために、アプリケーション固有のコンテキストや例を反映するように_最適化_されます。[Prompts For Edu](https://github.com/microsoft/prompts-for-edu?WT.mc_id=academic-105485-koreyst) リポジトリは、このアプローチの素晴らしい例で、教育分野におけるプロンプトのライブラリをキュレーションし、授業計画、カリキュラムデザイン、学生指導などの主要な目標に重点を置いています。

## サポートコンテンツ

プロンプトの構築を指示（タスク）とターゲット（主要コンテンツ）を持つものと考えると、_二次コンテンツ_は、**出力に何らかの影響を与える**ために提供する追加のコンテキストのようなものです。これには、調整パラメータ、フォーマット指示、トピック分類法などが含まれ、モデルが望ましいユーザーの目的や期待に合わせて応答を_カスタマイズ_するのに役立ちます。

例：カリキュラム内のすべての利用可能なコースについて、豊富なメタデータ（名前、説明、レベル、メタデータタグ、講師など）を持つコースカタログが与えられた場合：

- 「2023年秋のコースカタログを要約する」という指示を定義できます
- 望ましい出力のいくつかの例を提供するために主要コンテンツを使用できます
- 興味のあるトップ5の「タグ」を特定するために二次コンテンツを使用できます

これにより、モデルはいくつかの例で示されたフォーマットで要約を提供できますが、結果に複数のタグがある場合は、二次コンテンツで特定された5つのタグを優先することができます。

---

<!--
LESSON TEMPLATE:
このユニットはコアコンセプト#1をカバーする必要があります。
例や参考文献を使って概念を強化してください。

CONCEPT #3:
プロンプトエンジニアリング技術。
プロンプトエンジニアリングの基本的な技術は何ですか？
いくつかの演習で説明してください。
-->

## プロンプトのベストプラクティス

プロンプトがどのように_構築_されるかを知った今、それらをどのように_デザイン_するかを考え始めることができます。これを2つの部分に分けて考えることができます。正しい_心構え_を持つことと、正しい_技術_を適用することです。

### プロンプトエンジニアリングの心構え

プロンプトエンジニアリングは試行錯誤のプロセスであるため、3つの広範なガイドラインを念頭に置いてください：

1. **ドメイン理解が重要です。** 応答の正確性と関連性は、そのアプリケーションやユーザーが操作する_ドメイン_の関数です。直感とドメインの専門知識を活用して、技術をさらに**カスタマイズ**してください。たとえば、システムプロンプトで_ドメイン固有の人格_を定義したり、ユーザープロンプトで_ドメイン固有のテンプレート_を使用したりします。ドメイン固有のコンテキストを反映する二次コンテンツを提供するか、_ドメイン固有のキューや例_を使用してモデルを馴染みのある使用パターンに導きます。

2. **モデル理解が重要です。** モデルは本質的に確率的であることを知っていますが、モデルの実装は使用するトレーニングデータセット（事前トレーニングされた知識）、提供する機能（例：APIやSDK経由）および最適化されているコンテンツのタイプ（例：コード、画像、テキスト）によっても異なる場合があります。使用しているモデルの強みと制限を理解し、その知識を活用して_タスクを優先_したり、モデルの機能に最適化された_カスタマイズされたテンプレート_を作成したりします。

3. **反復と検証が重要です。** モデルは急速に進化しており、プロンプトエンジニアリングの技術も同様です。ドメインの専門家として、あなたの特定のアプリケーションに適用される他のコンテキストや基準があるかもしれません。それが広範なコミュニティには適用されないかもしれません。プロンプトエンジニアリングツールと技術を使用してプロンプトの構築を「ジャンプスタート」し、直感とドメインの専門知識を活用して結果を反復し検証します。洞察を記録し、他の人が将来より速く反復できるようにするための**知識ベース**（例：プロンプトライブラリ）を作成します。

## ベストプラクティス

次に、[OpenAI](https://help.openai.com/en/articles/6654000-best-practices-for-prompt-engineering-with-openai-api?WT.mc_id=academic-105485-koreyst) と [Azure OpenAI](https://learn.microsoft.com/azure/ai-services/openai/concepts/prompt-engineering#best-practices?WT.mc_id=academic-105485-koreyst) の実践者によって推奨される一般的なベストプラクティスを見てみましょう。

| 内容                             | 理由                                                                                                                                                                                                                                               |
| :------------------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 最新のモデルを評価する           | 新しいモデルの世代は、機能と品質が向上している可能性がありますが、コストが高くなる場合もあります。影響を評価し、移行の決定を行います。                                                                                                                  |
| 指示とコンテキストを分ける       | モデル/プロバイダーが指示、主要コンテンツ、二次コンテンツをより明確に区別する_デリミタ_を定義しているか確認します。これにより、モデルはトークンに対してより正確に重みを割り当てることができます。                                                                                         |
| 具体的で明確にする               | 望ましいコンテキスト、結果、長さ、フォーマット、スタイルなどについてより詳細を提供します。これにより、応答の品質と一貫性が向上します。再利用可能なテンプレートにレシピをキャプチャします。                                                                                              |
| 説明的で、例を使用する           | モデルは「見せて説明する」アプローチによりよく反応するかもしれません。`zero-shot` approach where you give it an instruction (but no examples) then try `few-shot` as a refinement, providing a few examples of the desired output. Use analogies. |
| Use cues to jumpstart completions | Nudge it towards a desired outcome by giving it some leading words or phrases that it can use as a starting point for the response.                                                                                                               |
| Double Down                       | Sometimes you may need to repeat yourself to the model. Give instructions before and after your primary content, use an instruction and a cue, etc. Iterate & validate to see what works.                                                         |
| Order Matters                     | The order in which you present information to the model may impact the output, even in the learning examples, thanks to recency bias. Try different options to see what works best.                                                               |
| Give the model an “out”           | Give the model a _fallback_ completion response it can provide if it cannot complete the task for any reason. This can reduce chances of models generating false or fabricated responses.                                                         |
|                                   |                                                                                                                                                                                                                                                   |

As with any best practice, remember that _your mileage may vary_ based on the model, the task and the domain. Use these as a starting point, and iterate to find what works best for you. Constantly re-evaluate your prompt engineering process as new models and tools become available, with a focus on process scalability and response quality.

<!--
LESSON TEMPLATE:
This unit should provide a code challenge if applicable

CHALLENGE:
Link to a Jupyter Notebook with only the code comments in the instructions (code sections are empty).

SOLUTION:
Link to a copy of that Notebook with the prompts filled in and run, showing what one example could be.
-->

## Assignment

Congratulations! You made it to the end of the lesson! It's time to put some of those concepts and techniques to the test with real examples!

For our assignment, we'll be using a Jupyter Notebook with exercises you can complete interactively. You can also extend the Notebook with your own Markdown and Code cells to explore ideas and techniques on your own.

### To get started, fork the repo, then

- (Recommended) Launch GitHub Codespaces
- (Alternatively) Clone the repo to your local device and use it with Docker Desktop
- (Alternatively) Open the Notebook with your preferred Notebook runtime environment.

### Next, configure your environment variables

- Copy the `.env.copy` file in repo root to `.env` and fill in the `AZURE_OPENAI_API_KEY`, `AZURE_OPENAI_ENDPOINT` and `AZURE_OPENAI_DEPLOYMENT` の値を使って始めてください。[Learning Sandbox section](../../../04-prompt-engineering-fundamentals/04-prompt-engineering-fundamentals) に戻って学び方を確認してください。

### 次に、Jupyter Notebookを開いてください

- ランタイムカーネルを選択します。オプション1または2を使用する場合、開発コンテナが提供するデフォルトのPython 3.10.xカーネルを選択してください。

これで演習を実行する準備が整いました。ここには_正解や不正解_はありません - 単に試行錯誤でオプションを探索し、特定のモデルとアプリケーションドメインで何が機能するかの直感を構築することです。

_このため、このレッスンにはコードソリューションセグメントはありません。代わりに、Notebookには「My Solution:」と題されたMarkdownセルがあり、参考として1つの例の出力を示しています。_

 <!--
LESSON TEMPLATE:
セクションを要約と自己学習のためのリソースでまとめます。
-->

## 知識チェック

次のうち、合理的なベストプラクティスに従った良いプロンプトはどれですか？

1. 赤い車の画像を見せてください
2. 日が沈む崖のそばに駐車している、ボルボ製のXC90モデルの赤い車の画像を見せてください
3. ボルボ製のXC90モデルの赤い車の画像を見せてください

A: 2、これは「何を」という詳細を提供し、具体的な（単なる車ではなく特定のメーカーとモデル）内容に入り、全体の設定も説明しているため、最良のプロンプトです。3も多くの説明を含んでいるため、次に良いです。

## 🚀 チャレンジ

「ボルボ製の赤い車の画像を見せてください」というプロンプトで「キュー」技術を活用できるか試してみてください。それは何に応答し、どのように改善しますか？

## 素晴らしい仕事！学び続けましょう

さまざまなプロンプトエンジニアリングの概念についてもっと学びたいですか？このトピックに関する他の素晴らしいリソースを見つけるために[学習継続ページ](https://aka.ms/genai-collection?WT.mc_id=academic-105485-koreyst)にアクセスしてください。

レッスン5に進み、[高度なプロンプト技術](../05-advanced-prompts/README.md?WT.mc_id=academic-105485-koreyst)を見てみましょう！

**免責事項**:
この文書は、機械翻訳AIサービスを使用して翻訳されています。正確性を期していますが、自動翻訳には誤りや不正確さが含まれる場合がありますのでご注意ください。原文書は、その言語での権威ある情報源と見なされるべきです。重要な情報については、専門の人間による翻訳をお勧めします。この翻訳の使用から生じる誤解や誤訳について、当社は責任を負いません。